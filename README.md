# FlareDrive-R2 Enhanced

基于 Cloudflare R2 + Workers 构建的增强版在线网盘系统，在原项目基础上进行了大量改进和功能增强。

> 📌 **基于项目**: [Cloudflare-R2-oss](https://github.com/ljxi/Cloudflare-R2-oss)
[FlareDrive-R2](https://github.com/willow-god/FlareDrive-R2)
> 🚀 **增强版本**: 完全重构的用户认证系统、权限管理和用户界面

## 🆕 主要改进和新增功能

### 🔐 全新的用户认证系统
- ✅ **自定义登录界面** - 替代原有的浏览器Basic Auth，提供美观的模态框登录
- ✅ **登录状态持久化** - 页面刷新后保持登录状态，无需重复登录
- ✅ **用户信息显示** - 显示当前登录用户名和权限状态
- ✅ **手动登录/退出** - 支持切换用户，避免浏览器密码缓存问题

### 🔒 增强的权限管理系统
- ✅ **只读用户支持** - 新增只读权限，格式：`username:password:r=dir1/,dir2/`
- ✅ **游客目录优化** - 游客目录对所有用户可见（公共目录概念）
- ✅ **权限继承逻辑** - 所有用户都可访问游客目录
- ✅ **细粒度控制** - 支持多层级权限：管理员、普通用户、只读用户、游客

### 🎨 全面重构的用户界面
- ✅ **响应式布局优化** - 登录按钮和菜单靠右显示，搜索框宽度自适应
- ✅ **权限感知UI** - 根据用户权限动态显示/隐藏功能
- ✅ **用户状态指示** - 清晰显示用户类型（管理员/普通/只读）
- ✅ **只读用户提示** - 只读用户界面显示权限限制提示

### 🔍 全新的全局搜索功能
- ✅ **真正的全局搜索** - 递归搜索所有有权限的目录（原版只能搜索当前目录）
- ✅ **实时搜索** - 输入即搜，500ms防抖优化
- ✅ **智能跳转** - 点击搜索结果直接跳转到文件所在目录
- ✅ **权限感知搜索** - 只搜索用户可访问的内容
- ✅ **搜索结果优化** - 显示文件完整路径，便于定位

### �️ 技术改进
- ✅ **API端点重构** - 新增 `/api/auth/login` 专用登录验证端点
- ✅ **认证机制优化** - localStorage持久化存储，自动注入认证头
- ✅ **错误处理改进** - 友好的错误提示，区分网络错误和权限错误
- ✅ **代码结构优化** - 组件化设计，响应式数据绑定

## 📊 功能对比

| 功能 | 原版 | 增强版 |
|------|------|--------|
| 登录方式 | 浏览器Basic Auth | 自定义登录界面 |
| 登录状态 | 刷新丢失 | 持久化保存 |
| 用户权限 | 管理员/普通用户 | 管理员/普通/只读/游客 |
| 搜索功能 | 当前目录搜索 | 全局递归搜索 |
| 权限显示 | 无明确提示 | 清晰的权限状态显示 |
| 游客目录 | 仅游客可见 | 所有用户可见 |
| UI布局 | 基础布局 | 响应式优化布局 |
| 只读权限 | 不支持 | 完整支持 |

## 🎯 权限系统详解

### 权限类型

| 用户类型 | 环境变量格式 | 示例 | 权限说明 |
|---------|-------------|------|---------|
| **管理员** | `username:password=*` | `admin:123456=*` | 🔓 访问所有目录，完整读写权限 |
| **普通用户** | `username:password=dir1/,dir2/` | `user:123456=docs/,photos/` | 📁 访问指定目录，完整读写权限 |
| **只读用户** | `username:password:r=dir1/,dir2/` | `guest:123456:r=public/,shared/` | 👁️ 访问指定目录，只读权限 |
| **游客** | `guest=dir/` 或 `GUEST=dir/` | `guest=public/` | 🌐 未登录用户可访问的公共目录 |

### 🚀 快速部署

### 前置要求

- Cloudflare 账号
- 已开通 R2 服务

### 部署步骤

### 1. 准备存储桶

前往 Cloudflare R2 控制台：

1. 新建存储桶（建议名称全小写）

   ![新建存储桶](https://blog.sztcrs.com/api/attachments/DsVUKdkdzfph/image/create-bucket.png)

2. 创建完成后，点开设置页面，在存储桶设置中启用「公开访问」

   ![存储桶设置](https://blog.sztcrs.com/api/attachments/o7OiiM2AZ3Me/image/r2.dev.png)

3. 复制“公共存储桶 URL”，格式如下：

```txt
https://pub-kdsjfhlasnwiuweia4387rfho85tnof4.r2.dev
```

### 2. 部署 Pages 服务

1. Fork 本项目仓库到你的 GitHub
2. 打开 Cloudflare Pages，新建一个站点
3. 点击「连接到 Git」并选择你的仓库
4. 保持默认的构建设置即可，第一次构建不会显示内容，为正常现象

### 3. 配置环境变量

![配置环境变量](https://blog.sztcrs.com/api/attachments/qiq8Iejmm4F9/image/3.png)

在 Cloudflare Pages 项目中，进入 **Settings → Environment Variables** 添加以下变量：

| 变量名              | 示例值                                                | 是否必要 | 说明                                           |
| ------------------- | ----------------------------------------------------- | -------- | ---------------------------------------------- |
| `PUBURL`            | `https://pub-kdsjfhlasnwiuweia4387rfho85tnof4.r2.dev` | ✅ 必填   | R2 公共存储桶地址                              |
| `admin:123456`      | `*`                                                   | ✅ 必填   | 管理员账号，格式为 `用户名:密码`               |
| `GUEST` 或 `guest`  | `public/`                                             | ❌ 可选   | 游客可访问的公共目录                           |
| `user1:123456`      | `user1/,shared/`                                      | ❌ 可选   | 普通用户及其可读写目录，支持多个目录           |
| `readonly:123456:r` | `public/,shared/`                                     | ❌ 可选   | 只读用户及其可查看目录，只能查看不能修改       |

#### 🔑 权限类型说明

| 用户类型 | 环境变量格式 | 示例 | 权限说明 |
|---------|-------------|------|---------|
| **管理员** | `username:password=*` | `admin:123456=*` | 🔓 访问所有目录，完整读写权限 |
| **普通用户** | `username:password=dir1/,dir2/` | `user:123456=docs/,photos/` | 📁 访问指定目录，完整读写权限 |
| **只读用户** | `username:password:r=dir1/,dir2/` | `guest:123456:r=public/,shared/` | 👁️ 访问指定目录，只读权限 |
| **游客** | `guest=dir/` 或 `GUEST=dir/` | `guest=public/` | 🌐 未登录用户可访问的公共目录 |

<p style="color: red !important; font-weight: bold;">
  ⚠️ 请勿开启 R2 存储桶的公开读写权限！否则你的存储资源可能会被恶意刷爆。
</p>

### 4. 绑定 R2 存储桶

部署完成后：

1. 进入 Cloudflare Pages 项目设置
2. 点击「R2 存储桶」
3. 添加一个绑定，变量名填写为：

```
BUCKET
```

并选择你的 R2 存储桶。

### 5. 重新部署项目

完成所有设置后，回到 Pages 控制台，点击「Deployments」页面右上角的「Trigger Redeploy」以重新部署服务。

### ⚙️ 自定义配置

#### 前端样式修改

由于 Wrangler 部署无法使用传统环境变量注入，我偷懒了，不想写环境变量，但是仍然可以简单的进行修改，请直接修改以下文件：

1. **背景图片**  
   修改文件：`assets/App.vue`  
   
   ```vue
   // 约第 213 行
   export default {
     data: () => ({
       ...
       backgroundImageUrl: "/assets/bg-light.webp"
     }),
   }
   ```
   
2. **页脚链接**  
   修改文件：`assets/Footer.vue`  
   
   ```html
   // 约第四十行
   <script>
   export default {
     name: "Footer",
     data() {
       return {
         homeUrl: "https://www.liushen.fun/",
         blogUrl: "https://blog.liushen.fun/",
         githubUrl: "https://github.com/willow-god",
         emailUrl: "mailto:01@liushen.fun"
       };
     }
   };
   </script>
   ```

#### 权限配置技巧

**基本规则：**
- 使用 `*` 作为值表示拥有所有目录权限
- 目录名必须以 `/` 结尾
- 避免在值的前后添加多余逗号（如 `,dir1/,` 会错误授予全部权限）
- 只读用户在用户名密码后添加 `:r` 标识

**配置示例：**
```bash
# 管理员 - 可访问所有目录
admin:your_strong_password=*

# 普通用户 - 可读写指定目录
alice:alice123=personal/,work/
bob:bob456=projects/,shared/

# 只读用户 - 只能查看指定目录
viewer:viewer789:r=public/,documents/
guest_user:guest123:r=public/

# 游客目录 - 未登录用户可访问
guest=public/
# 或者使用大写
GUEST=public/
```

**权限继承：**
- 所有用户都可以访问游客目录（如 `public/`）
- 只读用户可以查看指定目录和游客目录，但不能修改
- 普通用户可以读写指定目录和游客目录
- 管理员可以访问所有目录

### � 使用指南

#### 🔑 登录系统

1. **访问网站**：未登录时显示游客可访问的内容
2. **点击登录**：点击右上角登录按钮
3. **输入凭据**：输入用户名和密码
4. **自动跳转**：登录成功后显示用户有权限的目录

#### 👥 用户权限说明

**游客用户：**
- 📖 只能查看游客目录（如 `public/`）
- 🚫 无法上传或修改文件
- 🔍 可以搜索游客目录内容

**只读用户：**
- 📖 可以查看指定目录和游客目录
- 📥 可以下载文件
- 🔍 可以搜索有权限的目录
- 🚫 无法上传、删除或修改文件
- 💡 界面显示"(只读)"标识

**普通用户：**
- 📖 可以查看指定目录和游客目录
- 📤 可以上传文件到有权限的目录
- 🗑️ 可以删除和修改有权限目录的文件
- 📁 可以创建文件夹
- 🔍 可以搜索有权限的目录

**管理员用户：**
- 🔓 可以访问所有目录
- 💪 拥有完整的文件管理权限
- 👑 系统最高权限

#### 📁 文件操作

**上传文件：**
- **拖拽上传**：直接拖拽文件到页面
- **点击上传**：点击上传按钮选择文件
- **批量上传**：支持同时上传多个文件

**文件管理：**
- **预览文件**：点击文件名在线预览
- **下载文件**：右键菜单选择下载
- **重命名**：右键菜单选择重命名
- **删除文件**：右键菜单选择删除
- **移动文件**：拖拽到目标文件夹

**文件夹操作：**
- **创建文件夹**：点击上传按钮选择创建文件夹
- **进入文件夹**：点击文件夹名称
- **返回上级**：点击面包屑导航

#### 🔍 搜索功能

1. **输入搜索词**：在顶部搜索框输入关键词（至少2个字符）
2. **实时搜索**：系统自动搜索所有有权限的目录
3. **查看结果**：搜索结果显示文件名和完整路径
4. **快速跳转**：点击搜索结果跳转到文件所在目录

### �🔧 故障排查

1. **登录问题：**
   - 确认用户名密码正确
   - 检查环境变量格式是否正确
   - 只读用户确保添加了 `:r` 后缀

2. **权限问题：**
   - 确认用户有目标目录的访问权限
   - 检查目录名是否以 `/` 结尾
   - 只读用户无法进行写操作

3. **文件上传失败：**
   - 检查 R2 存储桶是否已绑定
   - 确认用户有目标目录的写入权限
   - 只读用户和游客无法上传文件

4. **搜索无结果：**
   - 确认搜索词至少2个字符
   - 检查用户是否有相关目录的访问权限
   - 搜索只在用户有权限的目录中进行

5. **样式未更新：**
   - 清除浏览器缓存
   - 确认修改已提交并重新部署

